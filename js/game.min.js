var Brick,Game,Hud,Player,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;Brick=function(superClass){extend(Brick,superClass);function Brick(texture,x,y,density){this.density=density!=null?density:0;Brick.__super__.constructor.call(this,texture,x,y)}Brick.prototype.onkill=function(){};Brick.prototype.clone=function(x,y){return new Brick(this.texture,x||this.x,y||this.y,this.density)};Brick.prototype.kill=function(){Brick.__super__.kill.apply(this,arguments);return this.onkill()};return Brick}(Fz2D.Entity);Hud=function(superClass){var Button;extend(Hud,superClass);Button=Fz2D.Input.Mouse.Button;function Hud(w,h,sprites){var font_16,font_32,size,text,y;Hud.__super__.constructor.call(this,0,0,w,h);font_32=new Fz2D.Font(sprites.getTexture("font_32"),32);font_16=new Fz2D.Font(sprites.getTexture("font_16"),16);text="Bricks of Babel";size=font_32.measureText(text);this.title=this.add(new Fz2D.Gui.Label(text,w-size.w>>1,100,font_32));text="LMB - drop / RMB - move up";size=font_16.measureText(text);this.help=this.add(new Fz2D.Gui.Label(text,w-size.w>>1,200,font_16));text="Press LMB to play";size=font_16.measureText(text);this.play=this.add(new Fz2D.Gui.Label(text,w-size.w>>1,300,font_16));this.play.blink=500;text="Game Over";size=font_32.measureText(text);this.gameover=this.add(new Fz2D.Gui.Label(text,w-size.w>>1,200,font_32));this.gameover.kill();y=this.add(new Fz2D.Entity(sprites.getTexture("remaining"),24,24)).y;this.remaining=this.add(new Fz2D.Gui.Label("0",4*32,y+16,font_32));this.remaining.setFormat("03");y=this.add(new Fz2D.Entity(sprites.getTexture("placed"),24,24+64+32)).y;this.placed=this.add(new Fz2D.Gui.Label("0",4*32,y+16,font_32));this.placed.setFormat("03");y=this.add(new Fz2D.Entity(sprites.getTexture("fallen"),24,24+3*64)).y;this.fallen=this.add(new Fz2D.Gui.Label("0",4*32,y+16,font_32));this.fallen.setFormat("03");y=this.add(new Fz2D.Entity(sprites.getTexture("raised"),24,24+4*64+32)).y;this.raised=this.add(new Fz2D.Gui.Label("0",4*32,y+16,font_32));this.raised.setFormat("03")}Hud.prototype.kill=function(){this.alive=false;this.title.kill();this.help.kill();this.play.kill();this.gameover.kill();this.remaining.setText("0");this.placed.setText("0");this.fallen.setText("0");this.raised.setText("0");return this.player.reset()};Hud.prototype.reset=function(){Hud.__super__.reset.apply(this,arguments);this.gameover.reset();return this.play.reset()};Hud.prototype.update=function(timer,input){Hud.__super__.update.apply(this,arguments);if(input.mouse.pressed[Button.LEFT]){return this.kill()}};return Hud}(Fz2D.Group);Player=function(superClass){var Button,Key;extend(Player,superClass);Button=Fz2D.Input.Mouse.Button;Key=Fz2D.Input.Keyboard.Key;function Player(w,h,sprites,world,push){var bridge_y,count,i,j,k,l,ref,ref1,ref2,wall_count,wol,wor,xl,xr,xw,y,yb;Player.__super__.constructor.call(this,0,0,w,h);this.world=world;this.push=push;this.random=new Fz2D.Random;this.brick_template=new Brick(sprites.getTexture("brick_32"));this.bridge=new Fz2D.Group(0,0,w,h);this.bricks=new Fz2D.Group(0,0,w,h);count=13;wall_count=18;bridge_y=2;this.bottom=600;xw=this.brick_template.w*count;xl=w-xw>>1;xr=xl+xw;yb=this.bottom-this.brick_template.h;wol=xl-this.brick_template.w*4;wor=xr+this.brick_template.w*3;this.byo=yb-this.brick_template.h*bridge_y;for(i=j=0,ref=wall_count-1;0<=ref?j<=ref:j>=ref;i=0<=ref?++j:--j){y=yb-i*this.brick_template.h;this.world.add(this.add(this.brick_template.clone(wol,y)));this.world.add(this.add(this.brick_template.clone(wor,y)))}for(i=k=0,ref1=count-1;0<=ref1?k<=ref1:k>=ref1;i=0<=ref1?++k:--k){this.world.add(this.add(this.brick_template.clone(xl+i*this.brick_template.w,yb)))}for(i=l=1,ref2=count+6;1<=ref2?l<=ref2:l>=ref2;i=1<=ref2?++l:--l){this.world.add(this.bridge.add(this.brick_template.clone(wol+i*this.brick_template.w,this.byo)))}this.add(this.bridge);this.add(this.bricks);this.total=count*(wall_count-3);this.dir=this.random.nextBool()*2-1;this.brick=this.world.add(this.add(this.brick_template.clone()));this.brick.exists=false;this.gameover=0;this.height_timer=0}Player.prototype.reset=function(){Player.__super__.reset.apply(this,arguments);this.hud.remaining.setText(this.total.toString());this.bridge.each(function(_this){return function(b){b.y=_this.byo;return _this.world.reset(b)}}(this));this.bricks.each(function(_this){return function(b){b.exists=false;return _this.world.kill(b)}}(this));return this.spawn()};Player.prototype.spawn=function(){this.dir=-this.dir;if(this.dir===1){this.source=this.bridge.first();this.target=this.bridge.last()}else{this.source=this.bridge.last();this.target=this.bridge.first()}this.brick.reset(this.source.x,this.source.y+this.source.h);return this.world.reset(this.brick)};Player.prototype.drop=function(){var brick,x,y;if(this.hud.remaining.is(0)){return}else{this.hud.remaining.dec()}this.push.play();this.height_timer=0;x=this.brick.x;y=this.brick.y;this.spawn();brick=this.bricks.recycle();if(brick){brick.reset(x,y,0);this.world.reset(brick)}else{brick=this.bricks.add(this.brick_template.clone(x,y));brick.density=15;brick.onkill=function(_this){return function(){_this.hud.placed.dec();return _this.hud.fallen.inc()}}(this);this.world.add(brick)}return this.hud.placed.inc()};Player.prototype.move=function(dt){this.brick.x+=(dt*.1|0)*this.dir;if(this.dir===1){if(this.brick.x>=this.target.x){this.brick.x=this.target.x;this.target=this.bridge.first();this.dir=-this.dir}}else if(this.dir===-1){if(this.brick.x<=this.target.x){this.brick.x=this.target.x;this.target=this.bridge.last();this.dir=-this.dir}}return this.world.reset(this.brick)};Player.prototype.lift=function(){var b;b=this.bridge.first();if(b.y<b.h){return}this.bridge.each(function(_this){return function(b){b.y-=b.h;return _this.world.reset(b)}}(this));this.brick.y-=b.h;return this.world.reset(this.brick)};Player.prototype.update=function(timer,input){Player.__super__.update.apply(this,arguments);this._calc_height();if(this.hud.remaining.is(0)){this.brick.exists=false;if(++this.gameover>100){this.height_timer=0;this._calc_height();this.gameover=0;this.alive=false;this.hud.reset()}return}this.move(timer.dt);if(input.mouse.pressed[Button.RIGHT]||input.keys.pressed[Key.SPACE]){return this.lift()}else if(input.mouse.pressed[Button.LEFT]){return this.drop()}};Player.prototype._calc_height=function(){var y;if(++this.height_timer<120){return}this.height_timer=0;y=this.bottom;this.bricks.each(function(b){return y=Math.min(y,b.y)});y=Math.max(0,Math.ceil((this.bottom-y)/this.brick.h)-2);return this.hud.raised.setText(y)};return Player}(Fz2D.Group);Game=function(superClass){extend(Game,superClass);function Game(){return Game.__super__.constructor.apply(this,arguments)}Game.prototype.w=window.innerWidth;Game.prototype.h=window.innerHeight;Game.prototype.bg="#D59C25";Game.prototype.fg="#5d2607";Game.prototype.assets={sprites:"sprites.atlas",sounds:{city:"city.ogg",push:"push.ogg"}};Game.prototype.plugins=[Fz2D.Plugins.GoogleAnalytics,Fz2D.Plugins.GitHub,Fz2D.Plugins.Stats,Fz2D.Plugins.Box2D];Game.prototype.github={username:"icebreaker",repository:"bricksofbabel"};Game.prototype.ga={id:"UA-3042007-2"};Game.prototype.onload=function(game){var hud,player,sounds;if(Fz2D.production!=null){game.input.mouse.hide()}sounds=game.assets.sounds;sounds.city.setVolume(70);sounds.city.play(true);sounds.push.setVolume(80);hud=new Hud(game.w,game.h,game.assets.sprites);player=new Player(game.w,game.h,game.assets.sprites,game.world,sounds.push);hud.player=player;player.hud=hud;player.alive=false;game.scene.add(player);return game.scene.add(hud)};return Game}(Fz2D.Game);Game.run();